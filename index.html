<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KeySpend</title>
  <link href="https://cdn.jsdelivr.net/npm/lucide-static@0.321.0/font/lucide.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: #0d0d0f;
      color: #fff;
    }
    header {
      padding: 16px 24px;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #111;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
    }
    button {
      background: #2563eb;
      border: none;
      padding: 10px 20px;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      transition: 0.2s;
    }
    button:hover { background: #1d4ed8; }
    input, select {
      background: #1a1a1a;
      border: 1px solid #333;
      color: #fff;
      border-radius: 6px;
      padding: 10px;
      width: 100%;
      margin-bottom: 12px;
    }
    .key-card {
      background: #141414;
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .verify-box {
      background: #141414;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
    }
    .warning {
      color: #fbbf24;
      background: #332f00;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
<header>
  <h2>KeySpend</h2>
  <div id="user-info"></div>
</header>

<div class="container" id="app"></div>

<script>
const app = document.getElementById('app');
const userInfo = document.getElementById('user-info');

function uuid() { return crypto.randomUUID(); }

function saveUser(u) { localStorage.setItem('user', JSON.stringify(u)); }
function getUser() { return JSON.parse(localStorage.getItem('user') || 'null'); }

function saveKeys(keys) { localStorage.setItem('keys', JSON.stringify(keys)); }
function getKeys() { return JSON.parse(localStorage.getItem('keys') || '[]'); }

function navigate(path) {
  history.pushState({}, '', path);
  render();
}

window.onpopstate = render;

function render() {
  const path = location.pathname;
  const user = getUser();
  userInfo.innerHTML = user ? `<b>${user.username}</b>` : '';
  if (path.startsWith('/verify/')) return renderVerify(path.split('/verify/')[1]);
  if (!user) return renderSignup();
  renderProfile();
}

function renderSignup() {
  app.innerHTML = `
    <h3>Create your KeySpend account</h3>
    <input id="username" placeholder="Username" />
    <input id="birthday" placeholder="Birthday (YYYY-MM-DD)" />
    <input id="pfp" placeholder="Profile picture URL (optional)" />
    <button id="signup">Sign Up</button>
  `;
  document.getElementById('signup').onclick = () => {
    const username = document.getElementById('username').value;
    const birthday = document.getElementById('birthday').value;
    const profile_pic = document.getElementById('pfp').value || 'https://i.imgur.com/8Km9tLL.png';
    if (!username || !birthday) return alert('Fill all fields.');
    saveUser({ id: uuid(), username, birthday, profile_pic });
    render();
  };
}

function renderProfile() {
  const user = getUser();
  const keys = getKeys().filter(k => k.user_id === user.id);
  app.innerHTML = `
    <h3>Welcome, ${user.username}</h3>
    <button id="new-key">Create New Key</button>
    <div id="keys-list">
      ${keys.length ? keys.map(k => `
        <div class="key-card">
          <b>${k.name}</b><br>
          <small>${location.origin}/verify/${k.id}</small>
        </div>
      `).join('') : `<p><i data-lucide="key"></i> Nothing here yet..</p>`}
    </div>
  `;
  lucide.createIcons();
  document.getElementById('new-key').onclick = renderCreateKey;
}

function renderCreateKey() {
  app.innerHTML = `
    <h3>Creating Key</h3>
    <p>Create your key here!</p>
    <input id="key-name" placeholder="Key Name" />
    <select id="checkpoint-count">
      ${Array.from({length:10}).map((_,i)=>`<option>${i+1}</option>`).join('')}
    </select>
    <input id="redirect-url" placeholder="Redirect URL or file link" />
    <select id="redirect-type">
      <option value="link">Open Link</option>
      <option value="file">Download File</option>
    </select>
    <button id="create">Create Key</button>
  `;
  document.getElementById('create').onclick = () => {
    const name = document.getElementById('key-name').value;
    const redirect_url = document.getElementById('redirect-url').value;
    const redirect_type = document.getElementById('redirect-type').value;
    const steps = parseInt(document.getElementById('checkpoint-count').value);
    if (!name || !redirect_url) return alert('Missing info.');
    const user = getUser();
    const key = {
      id: uuid(),
      user_id: user.id,
      name,
      steps,
      wait_time: 15,
      redirect_url,
      redirect_type
    };
    const keys = getKeys();
    keys.push(key);
    saveKeys(keys);
    navigate('/');
  };
}

function renderVerify(id) {
  const all = getKeys();
  const key = all.find(k => k.id === id);
  if (!key) {
    app.innerHTML = `<h3>404 Not Found</h3>`;
    return;
  }
  const creator = getUser() && getUser().id === key.user_id ? getUser() : getUser();
  app.innerHTML = `
    <div class="verify-box">
      <img src="${creator.profile_pic}" width="80" height="80" style="border-radius:50%;"><br>
      <h3>${creator.username}</h3>
      <p>Verifying access for <b>${key.name}</b></p>
      <p id="stage">Step 1 of 3: Wait 15 seconds...</p>
      <button id="verify-btn" disabled>Waiting...</button>
      <div class="warning">
        ⚠️ We aren't responsible for the file or link. Proceed only if you trust ${creator.username}.
      </div>
    </div>
  `;
  let seconds = key.wait_time;
  const btn = document.getElementById('verify-btn');
  const stage = document.getElementById('stage');
  const timer = setInterval(() => {
    seconds--;
    btn.innerText = `Wait ${seconds}s...`;
    if (seconds <= 0) {
      clearInterval(timer);
      btn.innerText = "Continue to Step 2";
      btn.disabled = false;
    }
  }, 1000);
  btn.onclick = () => {
    stage.innerText = "Step 2: Verify YouTube/TikTok engagement...";
    btn.innerText = "Verifying...";
    setTimeout(() => {
      stage.innerText = "Step 3: Complete!";
      btn.innerText = key.redirect_type === 'file' ? "Download File" : "Open Link";
      btn.onclick = () => window.open(key.redirect_url, '_blank');
    }, 5000);
  };
}

render();
</script>
<script src="https://unpkg.com/lucide@latest"></script>
</body>
</html>
